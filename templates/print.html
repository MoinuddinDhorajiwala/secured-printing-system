<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Print Document - {{ doc_name }}</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='mhssce.png') }}">
    <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='mhssce.png') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            500: '#667eea',
                            600: '#5a67d8',
                            700: '#4c51bf'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <div class="bg-gradient-to-r from-primary-500 to-primary-700 text-white shadow-xl">
        <div class="max-w-7xl mx-auto px-6 py-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <h1 class="text-2xl lg:text-3xl font-bold flex items-center gap-3">
                    <i class="fas fa-print text-3xl"></i>
                    Print Document
                </h1>
                <div class="bg-white/20 backdrop-blur-sm px-4 py-2 rounded-full">
                    <span class="text-sm font-medium truncate max-w-xs">{{ doc_name }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]">
            <!-- PDF Viewer -->
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-xl overflow-hidden">
                <!-- PDF Controls -->
                <div class="bg-gray-50 border-b border-gray-200 p-4">
                    <div class="flex flex-wrap items-center justify-center gap-4">
                        <!-- Navigation Controls -->
                        <div class="flex items-center gap-2 bg-white rounded-lg p-2 shadow-sm">
                            <button id="prev-page" class="px-3 py-2 bg-primary-500 text-white rounded-md hover:bg-primary-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-all duration-200 flex items-center gap-2">
                                <i class="fas fa-chevron-left"></i>
                                <span class="hidden sm:inline">Previous</span>
                            </button>
                            <span class="text-sm text-gray-600 mx-2">Page:</span>
                            <input type="number" id="page-num" value="1" min="1" 
                                   class="w-16 px-2 py-1 border border-gray-300 rounded text-center focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                            <span class="text-sm text-gray-600">of <span id="page-count" class="font-semibold">-</span></span>
                            <button id="next-page" class="px-3 py-2 bg-primary-500 text-white rounded-md hover:bg-primary-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-all duration-200 flex items-center gap-2">
                                <span class="hidden sm:inline">Next</span>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <!-- Zoom Controls -->
                        <div class="flex items-center gap-2 bg-white rounded-lg p-2 shadow-sm">
                            <button id="zoom-out" class="px-3 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-all duration-200">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <div id="zoom-level" class="px-3 py-1 bg-gray-100 rounded text-sm font-semibold text-gray-700 min-w-[60px] text-center">120%</div>
                            <button id="zoom-in" class="px-3 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-all duration-200">
                                <i class="fas fa-search-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- PDF Canvas Container -->
                <div class="h-full overflow-auto bg-gray-100 p-6 flex items-center justify-center">
                    <div id="loading" class="text-center">
                        <i class="fas fa-spinner fa-spin text-4xl text-primary-500 mb-4"></i>
                        <p class="text-gray-600 text-lg">Loading PDF...</p>
                    </div>
                    <canvas id="pdf-canvas" class="hidden shadow-2xl rounded-lg bg-white max-w-full h-auto"></canvas>
                </div>
            </div>
            
            <!-- Print Options -->
            <div class="bg-white rounded-2xl shadow-xl p-6 overflow-y-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                    <i class="fas fa-cog text-primary-500"></i>
                    Print Settings
                </h2>
                
                <!-- Document Info -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <h3 class="font-semibold text-blue-800 mb-2 flex items-center gap-2">
                        <i class="fas fa-file-pdf"></i>
                        Document Information
                    </h3>
                    <p class="text-blue-700 text-sm break-all">{{ doc_name }}</p>
                </div>
                
                <!-- Page Info -->
                <div id="page-info" class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-4 mb-6 text-center hidden">
                    <div id="total-pages" class="text-3xl font-bold text-green-700">-</div>
                    <div class="text-green-600 text-sm">Total Pages</div>
                </div>
                
                <!-- Print Form -->
                <form action="{{ url_for('print_document', doc_id=doc_id) }}" method="POST" class="space-y-6" id="printForm">
                    <!-- Printer Selection -->
                    <div>
                        <label for="printer" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-print text-primary-500"></i>
                            Select Printer
                        </label>
                        <select name="printer" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white">
            {% for printer in printers %}
                <option value="{{ printer }}">{{ printer }}</option>
            {% endfor %}
        </select>
                    </div>

                    <!-- Copies -->
                    <div>
                        <label for="copies" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-copy text-primary-500"></i>
                            Number of Copies
                        </label>
                        <input type="number" name="copies" id="copies" value="1" min="1" max="99"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               onchange="calculateCredits()">
                    </div>

                    <!-- Duplex Printing -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-copy text-primary-500"></i>
                            Print Options
                        </label>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center">
                                <input type="checkbox" name="duplex" id="duplex" value="1" 
                                       class="mr-2 text-primary-500 focus:ring-primary-500"
                                       onchange="calculateCredits()">
                                <span class="text-sm text-gray-700">Double-sided printing</span>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Double-sided printing reduces paper usage by 50%</p>
                    </div>

        <!-- Page Range -->
                    <div>
                        <label for="page_range" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-file-alt text-primary-500"></i>
                            Page Range
                        </label>
                        <input type="text" name="page_range" id="page_range" 
                               placeholder="e.g., 1-3,5 or leave empty for all pages"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               onchange="calculateCredits()">
                        <p class="text-xs text-gray-500 mt-1">Examples: 1-5, 1,3,5, or leave blank for all pages</p>
                    </div>

                    <!-- Credit Calculation Display -->
                    <div id="creditCalculation" class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-xl p-4 hidden">
                        <h3 class="font-semibold text-orange-800 mb-2 flex items-center gap-2">
                            <i class="fas fa-calculator"></i>
                            Credit Calculation
                        </h3>
                        <div class="space-y-1 text-sm text-orange-700">
                            <div id="pageCountDisplay">Total Pages: <span class="font-semibold">-</span></div>
                            <div id="copiesDisplay">Copies: <span class="font-semibold">-</span></div>
                            <div id="duplexDisplay">Duplex: <span class="font-semibold">-</span></div>
                            <div id="totalPagesDisplay">Total Pages to Print: <span class="font-semibold">-</span></div>
                            <div class="border-t border-yellow-300 pt-2 mt-2">
                                <div id="creditsDisplay" class="font-bold text-orange-800">Credits Required: <span class="text-xl">-</span></div>
                            </div>
                        </div>
                    </div>

        <!-- Watermark (Hidden - Always Blank) -->
                    <input type="hidden" name="watermark" value="">

                    <!-- Print Button -->
                    <button type="submit" id="printButton"
                            class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 px-6 rounded-lg font-semibold text-lg hover:from-green-600 hover:to-green-700 transform hover:scale-[1.02] transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center gap-3">
                        <i class="fas fa-print text-xl"></i>
                        Print Document
                    </button>
                </form>
                
                <!-- Back Button -->
                <a href="{{ url_for('preview_dashboard') }}" 
                   class="mt-4 w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white py-3 px-6 rounded-lg font-medium hover:from-gray-600 hover:to-gray-700 transform hover:scale-[1.02] transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                    <i class="fas fa-arrow-left"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <script>
        // Disable right-click context menu
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        // Disable keyboard shortcuts for printing
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey && (e.key === 'p' || e.key === 's')) || e.key === 'F12') {
                e.preventDefault();
            }
        });

        // PDF.js setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.2;
        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');

        // Load PDF
        const url = '{{ url_for("view_pdf", doc_id=doc_id) }}';
        
        pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
            pdfDoc = pdfDoc_;
            document.getElementById('page-count').textContent = pdfDoc.numPages;
            document.getElementById('total-pages').textContent = pdfDoc.numPages;
            document.getElementById('page-info').classList.remove('hidden');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('pdf-canvas').classList.remove('hidden');
            
            renderPage(pageNum);
        }).catch(function(error) {
            document.getElementById('loading').innerHTML = '<i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i><br>Error loading PDF: ' + error.message;
        });

        function renderPage(num) {
            pageRendering = true;
            pdfDoc.getPage(num).then(function(page) {
                const viewport = page.getViewport({scale: scale});
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                const renderTask = page.render(renderContext);

                renderTask.promise.then(function() {
                    pageRendering = false;
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });

            document.getElementById('page-num').value = num;
            updateNavigation();
        }

        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        function updateNavigation() {
            document.getElementById('prev-page').disabled = (pageNum <= 1);
            document.getElementById('next-page').disabled = (pageNum >= pdfDoc.numPages);
        }

        // Event listeners
        document.getElementById('prev-page').addEventListener('click', function() {
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        });

        document.getElementById('next-page').addEventListener('click', function() {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        });

        document.getElementById('page-num').addEventListener('change', function() {
            const num = parseInt(this.value);
            if (num > 0 && num <= pdfDoc.numPages) {
                pageNum = num;
                queueRenderPage(pageNum);
            }
        });

        document.getElementById('zoom-in').addEventListener('click', function() {
            scale += 0.2;
            document.getElementById('zoom-level').textContent = Math.round(scale * 100) + '%';
            queueRenderPage(pageNum);
        });

        document.getElementById('zoom-out').addEventListener('click', function() {
            if (scale > 0.4) {
                scale -= 0.2;
                document.getElementById('zoom-level').textContent = Math.round(scale * 100) + '%';
                queueRenderPage(pageNum);
            }
        });

        // Credit calculation functions
        function parsePageRange(pageRange, totalPages) {
            if (!pageRange || pageRange.trim() === '') {
                return totalPages;
            }
            
            let pages = new Set();
            const ranges = pageRange.split(',');
            
            for (let range of ranges) {
                range = range.trim();
                if (range.includes('-')) {
                    const [start, end] = range.split('-').map(n => parseInt(n.trim()));
                    if (!isNaN(start) && !isNaN(end) && start > 0 && end <= totalPages && start <= end) {
                        for (let i = start; i <= end; i++) {
                            pages.add(i);
                        }
                    }
                } else {
                    const page = parseInt(range);
                    if (!isNaN(page) && page > 0 && page <= totalPages) {
                        pages.add(page);
                    }
                }
            }
            
            return pages.size || totalPages;
        }

        function calculateCredits() {
            if (!pdfDoc) return;
            
            const totalPages = pdfDoc.numPages;
            const copies = parseInt(document.getElementById('copies').value) || 1;
            const pageRange = document.getElementById('page_range').value;
            const isDuplex = document.getElementById('duplex').checked;
            
            // Calculate pages to print
            const pagesToPrint = parsePageRange(pageRange, totalPages);
            let actualPages = pagesToPrint * copies;
            
            // Apply duplex discount (50% reduction for double-sided)
            if (isDuplex) {
                actualPages = Math.ceil(actualPages / 2);
            }
            
            // Calculate credits (2 credits per page)
            const creditsRequired = actualPages * 2;
            
            // Update display
            document.getElementById('creditCalculation').classList.remove('hidden');
            document.getElementById('pageCountDisplay').innerHTML = `Total Pages: <span class="font-semibold">${totalPages}</span>`;
            document.getElementById('copiesDisplay').innerHTML = `Copies: <span class="font-semibold">${copies}</span>`;
            document.getElementById('duplexDisplay').innerHTML = `Duplex: <span class="font-semibold">${isDuplex ? 'Yes (50% reduction)' : 'No'}</span>`;
            document.getElementById('totalPagesDisplay').innerHTML = `Total Pages to Print: <span class="font-semibold">${actualPages}</span>`;
            document.getElementById('creditsDisplay').innerHTML = `Credits Required: <span class="text-xl">${creditsRequired}</span>`;
            
            // Store credits required for form submission
            document.getElementById('printButton').setAttribute('data-credits', creditsRequired);
        }

        // Loading screen and form submission
        document.getElementById('printForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const creditsRequired = parseInt(document.getElementById('printButton').getAttribute('data-credits')) || 0;
            
            // Create loading overlay
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'loadingOverlay';
            loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingOverlay.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center shadow-2xl">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary-500 mx-auto mb-4"></div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Processing Print Job</h3>
                    <p class="text-gray-600 mb-4">Please wait while we process your print request...</p>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="text-sm text-yellow-800">
                            <i class="fas fa-coins text-yellow-600 mr-2"></i>
                            <strong>Credits to be deducted:</strong> ${creditsRequired}
                        </div>
                        <div class="text-xs text-yellow-600 mt-1">
                            This amount will be deducted from your account after successful printing
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(loadingOverlay);
            
            // Submit form after showing loading screen
            setTimeout(() => {
                this.submit();
            }, 1000);
        });

        // Calculate credits when PDF loads
        pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
            pdfDoc = pdfDoc_;
            document.getElementById('page-count').textContent = pdfDoc.numPages;
            document.getElementById('total-pages').textContent = pdfDoc.numPages;
            document.getElementById('page-info').classList.remove('hidden');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('pdf-canvas').classList.remove('hidden');
            
            renderPage(pageNum);
            
            // Calculate credits after PDF loads
            calculateCredits();
            
            // Add event listeners for credit recalculation
            document.getElementById('copies').addEventListener('change', calculateCredits);
            document.getElementById('page_range').addEventListener('input', calculateCredits);
            document.getElementById('duplex').addEventListener('change', calculateCredits);
        }).catch(function(error) {
            document.getElementById('loading').innerHTML = '<i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i><br>Error loading PDF: ' + error.message;
        });
    </script>
</body>
</html>
